name: Build Sing-Box Rule Set (.srs)

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-srs:
    runs-on: ubuntu-latest

    steps:
      # Step 1: 检出代码
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: 下载最新版 sing-box（Linux amd64）
      - name: Download sing-box binary
        run: |
          # 使用固定版本，推荐不要用 latest
          SINGBOX_VERSION=v1.12.9
          SINGBOX_VERSIONN=1.12.9

          # ✅ 正确的下载链接格式
          URL="https://github.com/sagernet/sing-box/releases/download/$SINGBOX_VERSION/sing-box-$SINGBOX_VERSIONN-linux-amd64.tar.gz"

          echo "Downloading Sing-Box from: $URL"
          curl -L -o sing-box.tar.gz "$URL"

          # 解压到目录
          mkdir -p sing-box-bin
          tar -xzf sing-box.tar.gz -C sing-box-bin

          # 赋予执行权限
          chmod +x sing-box-bin/sing-box-1.12.9-linux-amd64/sing-box

          # 可选：打印版本信息
          ./sing-box-bin/sing-box-1.12.9-linux-amd64/sing-box -v

      # Step 3: 使用 sing-box rule-set compile 编译 JSON 为 .srs
      - name: Compile Rule Set JSON to .srs
        run: |
          mkdir -p output

          # 调用 sing-box 进行编译
          ./sing-box-bin/sing-box-1.12.9-linux-amd64/sing-box rule-set compile \
            --input rules/my-rule-set.json \
            --output output/my-rule-set.srs

          # 查看结果
          ls -lh output/
