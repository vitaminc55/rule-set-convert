name: Build Sing-Box Rule Set (.srs)

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-srs:
    runs-on: ubuntu-latest

    steps:
      # Step 1: æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: ä¸‹è½½æœ€æ–°ç‰ˆ sing-boxï¼ˆLinux amd64ï¼‰
      - name: Download sing-box binary
        run: |
          # ä½¿ç”¨å›ºå®šç‰ˆæœ¬ï¼Œæ¨èä¸è¦ç”¨ latest
          SINGBOX_VERSION=v1.12.9
          SINGBOX_VERSIONN=1.12.9

          # âœ… æ­£ç¡®çš„ä¸‹è½½é“¾æ¥æ ¼å¼
          URL="https://github.com/sagernet/sing-box/releases/download/$SINGBOX_VERSION/sing-box-$SINGBOX_VERSIONN-linux-amd64.tar.gz"

          echo "Downloading Sing-Box from: $URL"
          curl -L -o sing-box.tar.gz "$URL"

          # è§£å‹åˆ°ç›®å½•
          mkdir -p sing-box-bin
          tar -xzf sing-box.tar.gz -C sing-box-bin

          # èµ‹äºˆæ‰§è¡Œæƒé™
          chmod +x sing-box-bin/sing-box-1.12.9-linux-amd64/sing-box

# Step 3: å®šä¹‰ä½ è¦ç¼–è¯‘çš„ rules/*.json æ–‡ä»¶åˆ—è¡¨ï¼ˆæ‰‹åŠ¨æŒ‡å®šï¼Œä¸è¦è‡ªåŠ¨æ£€æµ‹ï¼‰
      - name: Compile specific JSON rule files into .srs
        run: |
          # ğŸ“Œ åœ¨è¿™é‡ŒæŒ‡å®šä½ è¦ç¼–è¯‘çš„ JSON æ–‡ä»¶ï¼ˆæ”¾åœ¨ rules/ ç›®å½•ä¸‹ï¼‰
          # ä½ å¯ä»¥ä¿®æ”¹ä¸‹é¢çš„æ•°ç»„ï¼Œæ·»åŠ æˆ–åˆ é™¤æ–‡ä»¶
          RULE_JSON_FILES=(
            "rules/Proxy.json"
            "rules/Direct.json"
            "rules/cf-proxy.json"
            "rules/Outbounds.json"
            # æ·»åŠ æ›´å¤šæ–‡ä»¶...
          )

          echo "å¼€å§‹ç¼–è¯‘ä»¥ä¸‹è§„åˆ™æ–‡ä»¶ï¼š"
          for INPUT_JSON in "${RULE_JSON_FILES[@]}"; do
            echo "  - $INPUT_JSON"

            # è®¡ç®—å¯¹åº”çš„è¾“å‡º .srs æ–‡ä»¶è·¯å¾„ï¼Œæ¯”å¦‚ rules/rule1.json â†’ output/rule1.srs
            OUTPUT_SRS="output/$(basename "$INPUT_JSON" .json).srs"

            # è°ƒç”¨ sing-box ç¼–è¯‘
            ./sing-box-bin/sing-box-1.12.9-linux-amd64/sing-box rule-set compile \
              --output "$OUTPUT_SRS" "$INPUT_JSON"

            echo "âœ… å·²ç”Ÿæˆï¼š$OUTPUT_SRS"
          done

      # Step 4: å°†ç”Ÿæˆçš„ .srs æ–‡ä»¶æ·»åŠ ã€æäº¤å¹¶æ¨é€åˆ°ä»“åº“
      - name: Commit and push generated .srs files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # ä½¿ç”¨ Personal Access Token æ¨é€ï¼ˆæ¨èï¼Œæœ‰å†™å…¥æƒé™ï¼‰
          git remote set-url origin https://x-access-token:${{ secrets.GIT_PAT }}@github.com/${{ github.repository }}.git

          # æ·»åŠ  output/ ç›®å½•ä¸‹æ‰€æœ‰ .srs æ–‡ä»¶ï¼ˆä¼šè¢«è¦†ç›–ï¼‰
          git add output/*.srs

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          if git diff --quiet --cached; then
            echo "â„¹ï¸ æ²¡æœ‰ .srs æ–‡ä»¶å˜åŒ–ï¼Œè·³è¿‡æäº¤ã€‚"
          else
            echo "ğŸ“ æäº¤ç”Ÿæˆçš„ .srs æ–‡ä»¶..."
            git commit -m "ğŸ¤– Auto: Update selected SRS rule set files [skip ci]"

            git push origin HEAD:${{ github.ref }}
            echo "âœ… å·²æ¨é€æ›´æ–°çš„ .srs æ–‡ä»¶åˆ° GitHub ä»“åº“"
          fi

# Step 5: å°† output/*.srs æ–‡ä»¶æ¨é€åˆ° Codeberg ç§æœ‰ä»“åº“çš„ Sing-Box/RuleSet/ ç›®å½•
      - name: Push output .srs files to Codeberg (into Sing-Box/RuleSet/)
        run: |
          echo "å¼€å§‹æ¨é€ output/*.srs æ–‡ä»¶åˆ° Codeberg ç§æœ‰ä»“åº“çš„ Sing-Box/RuleSet/ ç›®å½•..."

          # ======================
          # é…ç½®ä½ çš„ Codeberg ç§æœ‰ä»“åº“åœ°å€
          # ======================
          CODEBERG_REPO="codeberg.org/Roc/Proxy-All.git"
          # æ›¿æ¢ä¸ºä½ çš„å®é™… Codeberg ç”¨æˆ·å å’Œ ç§æœ‰ä»“åº“å

          # æœ¬åœ°ä¸´æ—¶å…‹éš†ç›®å½•
          CODEBERG_DIR="./codeberg-srs-repo"

          # åˆ é™¤æ—§çš„å…‹éš†ï¼ˆå¦‚æœæœ‰ï¼‰
          rm -rf "$CODEBERG_DIR"

          # å…‹éš† Codeberg ç§æœ‰ä»“åº“ï¼ˆä½¿ç”¨ GitHub Secrets ä¸­çš„ PATï¼‰
          git clone "https://x-access-token:${{ secrets.Codeberg }}@$CODEBERG_REPO" "$CODEBERG_DIR"

          if [ $? -ne 0 ]; then
            echo "âŒ å…‹éš† Codeberg ç§æœ‰ä»“åº“å¤±è´¥ï¼è¯·æ£€æŸ¥ï¼š"
            echo "1. CODEBERG_REPO æ˜¯å¦æ­£ç¡®ï¼ˆhttps://codeberg.org/ç”¨æˆ·å/ä»“åº“å.gitï¼‰"
            echo "2. CODEBERG_PAT æ˜¯å¦æ­£ç¡®ä¸”æ‹¥æœ‰ write_repository æƒé™"
            exit 1
          fi

          cd "$CODEBERG_DIR"

          # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨: Sing-Box/RuleSet/
          mkdir -p "Sing-Box/RuleSet"

          # æ¸…ç©ºæˆ–è¦†ç›–è¯¥ç›®å½•ä¸‹çš„æ—§ .srs æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
          # ä½ å¯ä»¥é€‰æ‹©åˆ é™¤æ—§æ–‡ä»¶ï¼Œæˆ–è€…ç›´æ¥è¦†ç›–
          rm -f "Sing-Box/RuleSet/"*.srs

          # ä» GitHub Actions çš„ output/ ç›®å½•ä¸­å¤åˆ¶æ‰€æœ‰ .srs æ–‡ä»¶åˆ° Codeberg çš„ Sing-Box/RuleSet/ ç›®å½•
          cp -f ../output/*.srs "Sing-Box/RuleSet/"

          # æ£€æŸ¥æ˜¯å¦å¤åˆ¶æˆåŠŸ
          if ls "Sing-Box/RuleSet/"*.srs >/dev/null 2>&1; then
            echo "æ‰¾åˆ°ä»¥ä¸‹ .srs æ–‡ä»¶ï¼Œå‡†å¤‡æäº¤åˆ° Codeberg çš„ Sing-Box/RuleSet/ ç›®å½•ï¼š"
            ls -lh "Sing-Box/RuleSet/"*.srs

            # Git é…ç½®
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            git add "Sing-Box/RuleSet/"*.srs
            
            # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
            if git diff --quiet --cached; then
              echo "â„¹ï¸ æ²¡æœ‰ .srs æ–‡ä»¶å˜åŒ–ï¼Œè·³è¿‡æäº¤ã€‚"
            else
              echo "ğŸ“ æäº¤ .srs æ–‡ä»¶åˆ° Codeberg ç§æœ‰ä»“åº“..."

              git commit -m "ğŸ¤– Auto: Update SRS files in Sing-Box/RuleSet/ from GitHub Actions [skip ci]"

              # æ¨é€åˆ°é»˜è®¤åˆ†æ”¯ï¼ˆé€šå¸¸æ˜¯ mainï¼Œä¹Ÿå¯èƒ½æ˜¯ masterï¼Œè¯·æŒ‰ä½ çš„ä»“åº“ä¿®æ”¹ï¼‰
              git push origin master
              echo "âœ… å·²æ¨é€ .srs æ–‡ä»¶åˆ° Codeberg ç§æœ‰ä»“åº“çš„ Sing-Box/RuleSet/ ç›®å½•"
            fi
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°ä»»ä½• .srs æ–‡ä»¶ï¼Œè·³è¿‡æ¨é€ã€‚"
          fi

#       # Step 3: ä½¿ç”¨ sing-box rule-set compile ç¼–è¯‘ JSON ä¸º .srs
#       - name: Compile Rule Set JSON to .srs
#         run: |
#           mkdir -p output

#           # è°ƒç”¨ sing-box è¿›è¡Œç¼–è¯‘
#           ./sing-box-bin/sing-box-1.12.9-linux-amd64/sing-box rule-set compile \
#             --output output/my-rule-set.srs rules/my-rule-set.json

#           # æŸ¥çœ‹ç»“æœ
#           ls -lh output/
# # =============================
#       # å‡è®¾ä½ å·²ç»æˆåŠŸç”Ÿæˆäº† output/my-rule-set.srs
#       # =============================

#       # Step 4: å°†ç”Ÿæˆçš„ .srs æ–‡ä»¶æäº¤å¹¶æ¨é€åˆ° GitHub ä»“åº“
#       - name: Commit and push generated .srs file
#         if: success()  # ä»…åœ¨å‰é¢æ­¥éª¤æˆåŠŸæ—¶è¿è¡Œ
#         run: |
#           # è¿›å…¥é¡¹ç›®æ ¹ç›®å½•ï¼ˆå¦‚æœä¹‹å‰åœ¨å­ç›®å½•æ“ä½œï¼Œç¡®ä¿å›åˆ°ä»“åº“æ ¹ç›®å½•ï¼‰
#           cd "${GITHUB_WORKSPACE}"

#           # æ£€æŸ¥ output/my-rule-set.srs æ˜¯å¦å­˜åœ¨
#           if [ -f "output/my-rule-set.srs" ]; then
#             echo "âœ… æ‰¾åˆ°ç”Ÿæˆçš„ .srs æ–‡ä»¶ï¼Œå‡†å¤‡æäº¤..."

#             # åˆå§‹åŒ– gitï¼ˆå¦‚æœå°šæœªåˆå§‹åŒ–ï¼Œä½†é€šå¸¸ Actions å·²ç» clone äº†ä»“åº“ï¼‰
#             git config user.name "github-actions[bot]"
#             git config user.email "github-actions[bot]@users.noreply.github.com"

#             # ä½¿ç”¨ä½ çš„ä¸ªäºº Tokenï¼Œè€Œä¸æ˜¯ GITHUB_TOKENï¼ˆå› ä¸ºåè€…å¯èƒ½æ— æƒ pushï¼‰
#             git remote set-url origin https://x-access-token:${{ secrets.GIT_PAT }}@github.com/${{ github.repository }}.git

#             # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
#             git status

#             # æ·»åŠ ç”Ÿæˆçš„æ–‡ä»¶
#             git add output/my-rule-set.srs

#             # æ£€æŸ¥æ˜¯å¦æœ‰è¦æäº¤çš„æ–‡ä»¶
#             if git diff --quiet --cached; then
#               echo "â„¹ï¸ æ²¡æœ‰æ–‡ä»¶å˜åŒ–ï¼Œè·³è¿‡æäº¤ã€‚"
#             else
#               echo "ğŸ“ æäº¤ç”Ÿæˆçš„ .srs æ–‡ä»¶..."
#               git commit -m "ğŸ¤– Auto: Update generated SRS rule set file [skip ci]"

#               # æ¨é€åˆ°å½“å‰åˆ†æ”¯ï¼Œæ¯”å¦‚ main
#               git push origin HEAD:${{ github.ref }}
#               echo "âœ… å·²æ¨é€ .srs æ–‡ä»¶åˆ° GitHub ä»“åº“"
#             fi
#           else
#             echo "âŒ æœªæ‰¾åˆ° output/my-rule-set.srs æ–‡ä»¶ï¼Œè·³è¿‡æäº¤ã€‚"
#           fi
