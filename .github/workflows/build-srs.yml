name: Build Sing-Box Rule Set (.srs)

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-srs:
    runs-on: ubuntu-latest

    steps:
      # Step 1: æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: ä¸‹è½½æœ€æ–°ç‰ˆ sing-boxï¼ˆLinux amd64ï¼‰
      - name: Download sing-box binary
        run: |
          # ä½¿ç”¨å›ºå®šç‰ˆæœ¬ï¼Œæ¨èä¸è¦ç”¨ latest
          SINGBOX_VERSION=v1.12.9
          SINGBOX_VERSIONN=1.12.9

          # âœ… æ­£ç¡®çš„ä¸‹è½½é“¾æ¥æ ¼å¼
          URL="https://github.com/sagernet/sing-box/releases/download/$SINGBOX_VERSION/sing-box-$SINGBOX_VERSIONN-linux-amd64.tar.gz"

          echo "Downloading Sing-Box from: $URL"
          curl -L -o sing-box.tar.gz "$URL"

          # è§£å‹åˆ°ç›®å½•
          mkdir -p sing-box-bin
          tar -xzf sing-box.tar.gz -C sing-box-bin

          # èµ‹äºˆæ‰§è¡Œæƒé™
          chmod +x sing-box-bin/sing-box-1.12.9-linux-amd64/sing-box

# Step 3: å®šä¹‰ä½ è¦ç¼–è¯‘çš„ rules/*.json æ–‡ä»¶åˆ—è¡¨ï¼ˆæ‰‹åŠ¨æŒ‡å®šï¼Œä¸è¦è‡ªåŠ¨æ£€æµ‹ï¼‰
      - name: Compile specific JSON rule files into .srs
        run: |
          # ğŸ“Œ åœ¨è¿™é‡ŒæŒ‡å®šä½ è¦ç¼–è¯‘çš„ JSON æ–‡ä»¶ï¼ˆæ”¾åœ¨ rules/ ç›®å½•ä¸‹ï¼‰
          # ä½ å¯ä»¥ä¿®æ”¹ä¸‹é¢çš„æ•°ç»„ï¼Œæ·»åŠ æˆ–åˆ é™¤æ–‡ä»¶
          RULE_JSON_FILES=(
            "rules/1.json"
            "rules/2.json"
            "rules/my-rule-set.json"
            # æ·»åŠ æ›´å¤šæ–‡ä»¶...
          )

          echo "å¼€å§‹ç¼–è¯‘ä»¥ä¸‹è§„åˆ™æ–‡ä»¶ï¼š"
          for INPUT_JSON in "${RULE_JSON_FILES[@]}"; do
            echo "  - $INPUT_JSON"

            # è®¡ç®—å¯¹åº”çš„è¾“å‡º .srs æ–‡ä»¶è·¯å¾„ï¼Œæ¯”å¦‚ rules/rule1.json â†’ output/rule1.srs
            OUTPUT_SRS="output/$(basename "$INPUT_JSON" .json).srs"

            # è°ƒç”¨ sing-box ç¼–è¯‘
            ./sing-box-bin/sing-box-1.12.9-linux-amd64/sing-box rule-set compile \
              --output "$OUTPUT_SRS" "$INPUT_JSON"

            echo "âœ… å·²ç”Ÿæˆï¼š$OUTPUT_SRS"
          done

      # Step 4: å°†ç”Ÿæˆçš„ .srs æ–‡ä»¶æ·»åŠ ã€æäº¤å¹¶æ¨é€åˆ°ä»“åº“
      - name: Commit and push generated .srs files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # ä½¿ç”¨ Personal Access Token æ¨é€ï¼ˆæ¨èï¼Œæœ‰å†™å…¥æƒé™ï¼‰
          git remote set-url origin https://x-access-token:${{ secrets.GIT_PAT }}@github.com/${{ github.repository }}.git

          # æ·»åŠ  output/ ç›®å½•ä¸‹æ‰€æœ‰ .srs æ–‡ä»¶ï¼ˆä¼šè¢«è¦†ç›–ï¼‰
          git add output/*.srs

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          if git diff --quiet --cached; then
            echo "â„¹ï¸ æ²¡æœ‰ .srs æ–‡ä»¶å˜åŒ–ï¼Œè·³è¿‡æäº¤ã€‚"
          else
            echo "ğŸ“ æäº¤ç”Ÿæˆçš„ .srs æ–‡ä»¶..."
            git commit -m "ğŸ¤– Auto: Update selected SRS rule set files [skip ci]"

            git push origin HEAD:${{ github.ref }}
            echo "âœ… å·²æ¨é€æ›´æ–°çš„ .srs æ–‡ä»¶åˆ° GitHub ä»“åº“"
          fi


#       # Step 3: ä½¿ç”¨ sing-box rule-set compile ç¼–è¯‘ JSON ä¸º .srs
#       - name: Compile Rule Set JSON to .srs
#         run: |
#           mkdir -p output

#           # è°ƒç”¨ sing-box è¿›è¡Œç¼–è¯‘
#           ./sing-box-bin/sing-box-1.12.9-linux-amd64/sing-box rule-set compile \
#             --output output/my-rule-set.srs rules/my-rule-set.json

#           # æŸ¥çœ‹ç»“æœ
#           ls -lh output/
# # =============================
#       # å‡è®¾ä½ å·²ç»æˆåŠŸç”Ÿæˆäº† output/my-rule-set.srs
#       # =============================

#       # Step 4: å°†ç”Ÿæˆçš„ .srs æ–‡ä»¶æäº¤å¹¶æ¨é€åˆ° GitHub ä»“åº“
#       - name: Commit and push generated .srs file
#         if: success()  # ä»…åœ¨å‰é¢æ­¥éª¤æˆåŠŸæ—¶è¿è¡Œ
#         run: |
#           # è¿›å…¥é¡¹ç›®æ ¹ç›®å½•ï¼ˆå¦‚æœä¹‹å‰åœ¨å­ç›®å½•æ“ä½œï¼Œç¡®ä¿å›åˆ°ä»“åº“æ ¹ç›®å½•ï¼‰
#           cd "${GITHUB_WORKSPACE}"

#           # æ£€æŸ¥ output/my-rule-set.srs æ˜¯å¦å­˜åœ¨
#           if [ -f "output/my-rule-set.srs" ]; then
#             echo "âœ… æ‰¾åˆ°ç”Ÿæˆçš„ .srs æ–‡ä»¶ï¼Œå‡†å¤‡æäº¤..."

#             # åˆå§‹åŒ– gitï¼ˆå¦‚æœå°šæœªåˆå§‹åŒ–ï¼Œä½†é€šå¸¸ Actions å·²ç» clone äº†ä»“åº“ï¼‰
#             git config user.name "github-actions[bot]"
#             git config user.email "github-actions[bot]@users.noreply.github.com"

#             # ä½¿ç”¨ä½ çš„ä¸ªäºº Tokenï¼Œè€Œä¸æ˜¯ GITHUB_TOKENï¼ˆå› ä¸ºåè€…å¯èƒ½æ— æƒ pushï¼‰
#             git remote set-url origin https://x-access-token:${{ secrets.GIT_PAT }}@github.com/${{ github.repository }}.git

#             # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
#             git status

#             # æ·»åŠ ç”Ÿæˆçš„æ–‡ä»¶
#             git add output/my-rule-set.srs

#             # æ£€æŸ¥æ˜¯å¦æœ‰è¦æäº¤çš„æ–‡ä»¶
#             if git diff --quiet --cached; then
#               echo "â„¹ï¸ æ²¡æœ‰æ–‡ä»¶å˜åŒ–ï¼Œè·³è¿‡æäº¤ã€‚"
#             else
#               echo "ğŸ“ æäº¤ç”Ÿæˆçš„ .srs æ–‡ä»¶..."
#               git commit -m "ğŸ¤– Auto: Update generated SRS rule set file [skip ci]"

#               # æ¨é€åˆ°å½“å‰åˆ†æ”¯ï¼Œæ¯”å¦‚ main
#               git push origin HEAD:${{ github.ref }}
#               echo "âœ… å·²æ¨é€ .srs æ–‡ä»¶åˆ° GitHub ä»“åº“"
#             fi
#           else
#             echo "âŒ æœªæ‰¾åˆ° output/my-rule-set.srs æ–‡ä»¶ï¼Œè·³è¿‡æäº¤ã€‚"
#           fi
