name: Build Sing-Box Rule Set (.srs)

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-srs:
    runs-on: ubuntu-latest

    steps:
      # Step 1: 检出代码
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: 下载最新版 sing-box（Linux amd64）
      - name: Download sing-box binary
        run: |
          # 获取最新的 release（你也可以固定版本，比如 v1.9.0）
          SINGBOX_RELEASE=$(curl -s https://api.github.com/repos/sagernet/sing-box/releases/latest | grep tag_name | cut -d '"' -f 4)
          echo "Latest Sing-Box release: $SINGBOX_RELEASE"

          # 下载 Linux amd64 的 sing-box 压缩包
          URL="https://github.com/sagernet/sing-box/releases/download/$SINGBOX_RELEASE/sing-box-linux-amd64-$SINGBOX_RELEASE.tar.gz"
          echo "Downloading from $URL"
          curl -L -o sing-box.tar.gz "$URL"

          # 解压
          mkdir -p sing-box-bin
          tar -xzf sing-box.tar.gz -C sing-box-bin

          # 赋予执行权限
          chmod +x sing-box-bin/sing-box

          # 可选：查看版本
          ./sing-box-bin/sing-box -v

      # Step 3: 使用 sing-box rule-set compile 编译 JSON 为 .srs
      - name: Compile Rule Set JSON to .srs
        run: |
          mkdir -p output

          # 调用 sing-box 进行编译
          ./sing-box-bin/sing-box rule-set compile \
            --input rules/my-rule-set.json \
            --output output/my-rule-set.srs

          # 查看结果
          ls -lh output/
